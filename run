#!/bin/bash
set -eou pipefail

main_env_dir="env-main"

dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m' # No Color

command="${1:-}"

if [ -z "$command" ]; then
	echo -e "${RED}[error] no command entered${NC}"
	exit 1
fi

shift;

case "$command" in
	"setup"|"s")
		env_repo_default=${1:-}

		echo -e "${CYAN}$(date '+%F %T') Setup started at $(date '+%F %T')${NC}"

		git_repo=''

		if [ -d "$dir/$main_env_dir" ]; then
			git_repo=$(git --git-dir="$dir/$main_env_dir/.git" remote get-url origin || :);
		fi

		if [ -z "$git_repo" ]; then
			rm -rf "${dir:?}/$main_env_dir"

			if [ -z "$env_repo_default" ]; then
				read -r -e -p "Enter the main (global) git environment repository: " \
					-i "your-repo.git" git_repo
			else
				git_repo="$env_repo_default"
			fi

			git config --global credential.helper store
			git clone "$git_repo" "$dir/$main_env_dir"
		fi
		;;
	"reset")
		rm -rf "${dir:?}/$main_env_dir"
		rm -rf "$dir/tmp"
		;;
	"stop-all")
		mapfile -t list < <(sudo docker ps -q)
		[[ ${#list[@]} -gt 0 ]] && sudo docker container stop "${list[@]}"
		;;
	"rm-all")
		mapfile -t list < <(sudo docker ps -aq)
		[[ ${#list[@]} -gt 0 ]] && sudo docker container rm -f "${list[@]}"
		;;
	"launch"|"l")
		"$dir/launch" "${@}"
		;;
	*)
		echo -e "${RED}[error] invalid command: $command${NC}"
		exit 1
		;;
esac
